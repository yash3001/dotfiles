'use strict';(function(k){"object"==typeof exports&&"object"==typeof module?k(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],k):k(CodeMirror)})(function(k){function x(a,e){function c(b){if(!d.parentNode)return k.off(document,"mousemove",c);d.style.top=Math.max(0,b.clientY-d.offsetHeight-5)+"px";d.style.left=b.clientX+5+"px"}var d=document.createElement("div");d.className="CodeMirror-lint-tooltip";d.appendChild(e.cloneNode(!0));document.body.appendChild(d);
k.on(document,"mousemove",c);c(a);null!=d.style.opacity&&(d.style.opacity=1);return d}function y(a){a.parentNode&&(null==a.style.opacity&&a.parentNode&&a.parentNode.removeChild(a),a.style.opacity=0,setTimeout(function(){a.parentNode&&a.parentNode.removeChild(a)},600))}function t(a,e,c){function d(){k.off(c,"mouseout",d);b&&(y(b),b=null)}var b=x(a,e),g=setInterval(function(){if(b)for(var f=c;;f=f.parentNode){f&&11==f.nodeType&&(f=f.host);if(f==document.body)return;if(!f){d();break}}if(!b)return clearInterval(g)},
400);k.on(c,"mouseout",d)}function z(a,e,c){this.marked=[];this.options=e;this.timeout=null;this.hasGutter=c;this.onMouseOver=function(d){var b=d.target||d.srcElement;if(/\bCodeMirror-lint-mark-/.test(b.className)){b=b.getBoundingClientRect();var g=a.findMarksAt(a.coordsChar({left:(b.left+b.right)/2,top:(b.top+b.bottom)/2},"client"));b=[];for(var f=0;f<g.length;++f){var h=g[f].__annotation;h&&b.push(h)}if(b.length){g=d.target||d.srcElement;f=document.createDocumentFragment();for(h=0;h<b.length;h++)f.appendChild(u(b[h]));
t(d,f,g)}}};this.waitingFor=0}function n(a){var e=a.state.lint;e.hasGutter&&a.clearGutter("CodeMirror-lint-markers");for(a=0;a<e.marked.length;++a)e.marked[a].clear();e.marked.length=0}function A(a,e,c,d){var b=document.createElement("div"),g=b;b.className="CodeMirror-lint-marker-"+e;c&&(g=b.appendChild(document.createElement("div")),g.className="CodeMirror-lint-marker-multiple");if(0!=d)k.on(g,"mouseover",function(f){t(f,a,g)});return b}function u(a){var e=a.severity;e||(e="error");var c=document.createElement("div");
c.className="CodeMirror-lint-message-"+e;"undefined"!=typeof a.messageHTML?c.innerHTML=a.messageHTML:c.appendChild(document.createTextNode(a.message));return c}function B(a,e,c){function d(){g=-1;a.off("change",d)}var b=a.state.lint,g=++b.waitingFor;a.on("change",d);return e(a.getValue(),function(f,h){a.off("change",d);b.waitingFor==g&&(h&&f instanceof k&&(f=h),a.operation(function(){p(a,f)}))},c,a)}function q(a,e){var c=a.state.lint,d=c.options,b=d.options||d,g=d.getAnnotations||a.getHelper(k.Pos(0,
0),"lint");if(g)if(!e&&c.options.autoLintMaxLen&&a.getValue().length>c.options.autoLintMaxLen)c.autolinted&&c.marked&&c.marked.length&&(n(a),c.autolinted=!1);else{c.autolinted=!e;if(d.async||g.async)return B(a,g,b);var f=g(a.getValue(),b,a);if(f){if(f.then)return f.then(function(h){a.operation(function(){p(a,h)})});a.operation(function(){p(a,f)});return f}}}function p(a,e){n(a);for(var c=a.state.lint,d=c.options,b=[],g=0;g<e.length;++g){var f=e[g],h=f.from.line;(b[h]||(b[h]=[])).push(f)}for(g=0;g<
b.length;++g)if(f=b[g]){h=null;for(var v=c.hasGutter&&document.createDocumentFragment(),r=0;r<f.length;++r){var l=f[r],m=l.severity;m||(m="error");"error"!=h&&(h=m);d.formatAnnotation&&(l=d.formatAnnotation(l));c.hasGutter&&v.appendChild(u(l));l.to&&c.marked.push(a.markText(l.from,l.to,{className:"CodeMirror-lint-mark-"+m,__annotation:l}))}c.hasGutter&&a.setGutterMarker(g,"CodeMirror-lint-markers",A(v,h,1<f.length,c.options.tooltips))}if(d.onUpdateLinting)d.onUpdateLinting(e,b,a)}function w(a){var e=
a.state.lint;e&&(clearTimeout(e.timeout),e.timeout=setTimeout(function(){q(a)},e.options.delay||500))}k.defineOption("lint",!1,function(a,e,c){c&&c!=k.Init&&(n(a),!1!==a.state.lint.options.lintOnChange&&a.off("change",w),k.off(a.getWrapperElement(),"mouseover",a.state.lint.onMouseOver),clearTimeout(a.state.lint.timeout),delete a.state.lint);if(e){var d=a.getOption("gutters");c=!1;for(var b=0;b<d.length;++b)"CodeMirror-lint-markers"==d[b]&&(c=!0);d=a.state;b=e;b instanceof Function?b={getAnnotations:b}:
b&&!0!==b||(b={});c=d.lint=new z(a,b,c);if(!1!==c.options.lintOnChange)a.on("change",w);if(0!=c.options.tooltips&&"gutter"!=c.options.tooltips)k.on(a.getWrapperElement(),"mouseover",c.onMouseOver);!1!==e.lintOnChange&&q(a)}});k.defineExtension("performLint",function(a){if(this.state.lint)return q(this,a)})});
