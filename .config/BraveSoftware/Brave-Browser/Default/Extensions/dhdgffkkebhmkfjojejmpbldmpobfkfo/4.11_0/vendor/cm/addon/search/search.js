'use strict';(function(f){"object"==typeof exports&&"object"==typeof module?f(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],f):f(CodeMirror)})(function(f){function K(a){var b=a.query;"string"==typeof b?b=new RegExp(b.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),a.caseInsensitive?"gi":"g"):b.global||(b=new RegExp(a.text,a.caseInsensitive?"gi":"g"));
return{token:function(c){b.lastIndex=c.pos;var d=b.exec(c.string);if(d&&d.index==c.pos)return c.pos+=d[0].length||1,"searching";d?c.pos=d.index:c.skipToEnd()}}}function L(){this.overlay=this.posFrom=this.posTo=this.lastPattern=this.pattern=null}function q(a){return a.state.search||(a.state.search=new L)}function v(a,b,c){var d="";if(b){var e=b.caseInsensitive;d=b.query}return a.getSearchCursor(d,c,{caseFold:e,multiline:!0})}function M(a,b,c,d,e){return a.openDialog(b,d,{value:c,selectValueOnOpen:!0,
closeOnEnter:!1,onClose:function(){w(a)},onKeyDown:e,closeOnBlur:!1,bottom:!0})}function D(a,b,c,d,e){if(a.openDialog)return a.openDialog(b,function(g,n){f.e_stop(n);return e.apply(this,arguments)},{value:d,selectValueOnOpen:!0,closeOnBlur:!1,bottom:!0,closeOnEnter:!1});e(prompt(c,d))}function N(a,b,c,d,e,g){if(a.openConfirm)return a.openConfirm(b,d,{onKeyDown:g,onClose:e,closeOnBlur:!1});if(confirm(c))d[0]()}function r(a,b){a=$(a.display.wrapper);b=void 0!==b?b:a.find(".CodeMirror-search-field").val();
var c=a.find(".CodeMirror-search-re-field").is(":checked");a=!a.find(".CodeMirror-search-case-field").is(":checked");if(c)try{var d={query:new RegExp(b,a?"i":""),text:b,caseInsensitive:a,regex:c}}catch(e){}else d={query:b,text:b,caseInsensitive:a,regex:c};d&&d.query&&("string"==typeof d.query?""!=d.query:!d.query.test(""))||(d={query:/x^/,text:""});return d}function y(a,b,c){b.pattern=c;a.removeOverlay(b.overlay,c.caseInsensitive);b.overlay=K(c);a.addOverlay(b.overlay);a.showMatchesOnScrollbar&&(b.annotate&&
(b.annotate.clear(),b.annotate=null),b.annotate=a.showMatchesOnScrollbar(c.query,c.caseInsensitive),$(a.display.wrapper).find(".CodeMirror-search-field").toggleClass("no-result",0>=b.annotate.matches.length))}function G(a,b){return""+a.query==""+b.query&&a.regex==b.regex&&a.caseInsensitive==b.caseInsensitive}function E(a,b,c,d){var e,g=q(a);if(g.pattern&&(e=r(a))){if(G(g.pattern,e))return z(a,b)}else e=e||a.getSelection()||g.lastPattern||"";"string"==typeof e&&(e=r(a,e));e.query instanceof RegExp&&
"x^"==e.query.source&&(e=null);if(c&&a.openDialog){var n=null,t=function(k,h){k=r(a);f.e_stop(h);g.pattern&&G(g.pattern,k)||(y(a,g,k),g.posFrom=g.posTo=a.getCursor());n&&(n.style.opacity=1);z(a,h.shiftKey,function(l,m){var p;3>m.line&&document.querySelector&&(p=a.display.wrapper.querySelector(".CodeMirror-dialog"))&&p.getBoundingClientRect().bottom-4>a.cursorCoords(m,"window").top&&((n=p).style.opacity=.4)})};if(!g.pattern){x(a);var u=M(a,H(e),e?e.text:"",t,function(k,h){var l=f.keyName(k),m=a.getOption("extraKeys");
l=m&&m[l]||f.keyMap[a.getOption("keyMap")][l];m=r(a);if(!(m.query instanceof RegExp&&"x^"==m.query.source))if("findNext"==l||"findPrev"==l||"findPersistentNext"==l||"findPersistentPrev"==l)f.e_stop(k),y(a,q(a),m),a.execCommand(l);else if("find"==l||"findPersistent"==l)f.e_stop(k),t(h,k)})}d&&e&&(y(a,g,e),z(a,b))}else x(a),u=D(a,H(),f.I18N.getMessage("Search_for")+":",e,function(k){k&&!g.pattern&&a.operation(function(){y(a,g,r(a));g.posFrom=g.posTo=a.getCursor();z(a,b)})});u&&A(a,{close:function(){u();
g.dialog=null}});g.dialog&&!g.dialog.initialized&&(g.dialog.initialized=!0,c=$(a.display.wrapper),c.find(".CodeMirror-search-find-button").on("click",function(){f.commands.findNext(a)}),c.find(".CodeMirror-search-find-prev-button").on("click",function(){f.commands.findPrev(a)}),c.find(".CodeMirror-search-close-button").on("click",function(){g.dialog&&g.dialog.close&&g.dialog.close()}))}function z(a,b,c){a.operation(function(){var d=q(a),e=v(a,d.pattern,b?d.posFrom:d.posTo);if(!e.find(b)&&(e=v(a,d.pattern,
b?f.Pos(a.lastLine()):f.Pos(a.firstLine(),0)),!e.find(b)))return;a.setSelection(e.from(),e.to());a.scrollIntoView({from:e.from(),to:e.to()},20);d.posFrom=e.from();d.posTo=e.to();c&&c(e.from(),e.to())})}function w(a,b){return a.operation(function(){var c=q(a);if(!c.closing){if(c.dialog&&!b){c.closing=!0;c.dialog.close();c.closing=!1;var d=!0}c.lastPattern=c.pattern;if(!c.pattern)return d;c.pattern=null;a.removeOverlay(c.overlay);c.annotate&&(c.annotate.clear(),c.annotate=null);return!0}})}function I(a,
b,c){a.operation(function(){for(var d=v(a,b);d.findNext();)if("string"!=typeof query){var e=a.getRange(d.from(),d.to()).match(b.query);d.replace(c.replace(/\$(\d)/g,function(g,n){return e[n]}))}else d.replace(c)})}function J(a,b){if(!a.getOption("readOnly")){var c=a.getSelection()||q(a).lastPattern||"";"string"==typeof c&&(c=r(a,c));var d=q(a),e=(b?f.I18N.getMessage("Replace_all_with"):f.I18N.getMessage("Replace"))+":";x(a);var g=D(a,e+' <input type="text" style="width: 40em" class="CodeMirror-search-field" spellcheck="false"/> <input type="checkbox" style="width: auto" class="CodeMirror-search-re-field"/> <span style="color: #888" class="CodeMirror-search-hint">.*</span> <input type="checkbox" style="width: auto" class="CodeMirror-search-case-field"/> <span style="color: #888" class="CodeMirror-search-hint">Aa</span>',
e,c.text,function(n){if(n){var t=r(a);x(a);var u=D(a,'<span class="CodeMirror-search-label">'+f.I18N.getMessage("Replace_with")+':</span> <input type="text" style="width: 40em" class="CodeMirror-search-field" spellcheck="false"/>',f.I18N.getMessage("Replace_with")+":","",function(k){if(b)I(a,t,k);else{w(a);var h=v(a,t,a.getCursor("from")),l=function(){var p=h.from(),B;if(!(B=h.findNext())&&(h=v(a,t),!(B=h.findNext())||p&&h.from().line==p.line&&h.from().ch==p.ch))return;a.setSelection(h.from(),h.to());
a.showInCenter?a.showInCenter():a.scrollIntoView({from:h.from(),to:h.to()});window.setTimeout(function(){x(a);var C=N(a,'<span class="CodeMirror-search-label">'+f.I18N.getMessage("Replace_")+"</span><button>"+f.I18N.getMessage("Yes")+"</button><button>"+f.I18N.getMessage("No")+"</button><button>"+f.I18N.getMessage("Replace_All")+"</button><button>"+f.I18N.getMessage("Stop")+"</button>",f.I18N.getMessage("Replace_"),[function(){m(B)},l,function(){I(a,t,k)}],function(F){d.dialog=null},function(F){if("Esc"==
f.keyName(F))return f.e_stop(F),w(a)});C&&A(a,{close:function(){C();d.dialog=null}})},1)},m=function(p){h.replace("string"==typeof n?k:k.replace(/\$(\d)/g,function(B,C){return p[C]}));l()};l()}});u&&A(a,{close:function(){u();d.dialog=null}})}});g&&A(a,{close:function(){g();d.dialog=null}})}}var H=function(a){return'<span class="CodeMirror-search-label">'+f.I18N.getMessage("Search_for")+':</span> <input type="text" style="width: 40em" class="CodeMirror-search-field" spellcheck="false"/> <input type="checkbox" style="width: auto" class="CodeMirror-search-re-field" '+
(a&&a.regex?"checked":"")+' /> <span style="color: #888" class="CodeMirror-search-hint">.*</span> <input type="checkbox" style="width: auto" class="CodeMirror-search-case-field" '+(!a||a.caseInsensitive?"":"checked")+' /> <span style="color: #888" class="CodeMirror-search-hint">Aa</span><button class="CodeMirror-search-find-button">'+f.I18N.getMessage("Find_Next")+'</button><button class="CodeMirror-search-find-prev-button">'+f.I18N.getMessage("Find_Previous")+'</button><button class="CodeMirror-search-close-button">'+
f.I18N.getMessage("Close")+"</button>"},x=function(a){a=q(a);a.dialog&&(a.closing=!0,a.dialog.close(),a.closing=!1)},A=function(a,b){q(a).dialog=b};f.commands.find=f.commands.findPersistent=function(a){w(a,!0);E(a,!1,!0)};f.commands.findNext=f.commands.findPersistentNext=function(a){E(a,!1,!0,!0)};f.commands.findPrev=f.commands.findPersistentPrev=function(a){E(a,!0,!0,!0)};f.commands.clearSearch=w;f.commands.replace=J;f.commands.replaceAll=function(a){J(a,!0)}});
