'use strict';(function(h){"object"==typeof exports&&"object"==typeof module?h(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],h):h(CodeMirror)})(function(h){function w(b,a){this.cm=b;this.options=a;this.widget=null;this.tick=this.debounce=0;this.startPos=this.cm.getCursor("start");this.startLen=this.cm.getLine(this.startPos.line).length-this.cm.getSelection().length;var d=this;b.on("cursorActivity",this.activityFunc=function(){d.cursorActivity()})}
function F(b,a){function d(m,g){var n="string"!=typeof g?function(p){return g(p,a)}:e.hasOwnProperty(g)?e[g]:g;l[m]=n}var e={Up:function(){a.moveFocus(-1)},Down:function(){a.moveFocus(1)},PageUp:function(){a.moveFocus(-a.menuSize()+1,!0)},PageDown:function(){a.moveFocus(a.menuSize()-1,!0)},Home:function(){a.setFocus(0)},End:function(){a.setFocus(a.length-1)},Enter:a.pick,Tab:a.pick,Esc:a.close},c=b.options.customKeys,l=c?{}:e;if(c)for(var f in c)c.hasOwnProperty(f)&&d(f,c[f]);if(b=b.options.extraKeys)for(f in b)b.hasOwnProperty(f)&&
d(f,b[f]);return l}function x(b,a){for(;a&&a!=b;){if("LI"===a.nodeName.toUpperCase()&&a.parentNode==b)return a;a=a.parentNode}}function y(b,a){this.completion=b;this.data=a;this.picked=!1;var d=this,e=b.cm,c=this.hints=document.createElement("ul");c.className="CodeMirror-hints";this.selectedHint=a.selectedHint||0;for(var l=a.list,f=0;f<l.length;++f){var m=c.appendChild(document.createElement("li")),g=l[f],n="CodeMirror-hint"+(f!=this.selectedHint?"":" CodeMirror-hint-active");null!=g.className&&(n=
g.className+" "+n);m.className=n;g.render?g.render(m,a,g):m.appendChild(document.createTextNode(g.displayText||("string"==typeof g?g:g.text)));m.hintId=f}f=e.cursorCoords(b.options.alignWithWord?a.from:null);var p=f.left,t=f.bottom,z=!0;c.style.left=p+"px";c.style.top=t+"px";m=window.innerWidth||Math.max(document.body.offsetWidth,document.documentElement.offsetWidth);var q=window.innerHeight||Math.max(document.body.offsetHeight,document.documentElement.offsetHeight);(b.options.container||document.body).appendChild(c);
g=c.getBoundingClientRect();var r=g.bottom-q;n=c.scrollHeight>c.clientHeight+1;var A=e.getScrollInfo();0<r&&(r=g.bottom-g.top,0<f.top-(f.bottom-g.top)-r?(c.style.top=(t=f.top-r)+"px",z=!1):r>q&&(c.style.height=q-5+"px",c.style.top=(t=f.bottom-g.top)+"px",q=e.getCursor(),a.from.ch!=q.ch&&(f=e.cursorCoords(q),c.style.left=(p=f.left)+"px",g=c.getBoundingClientRect())));q=g.right-m;0<q&&(g.right-g.left>m&&(c.style.width=m-5+"px",q-=g.right-g.left-m),c.style.left=(p=f.left-q)+"px");if(n)for(f=c.firstChild;f;f=
f.nextSibling)f.style.paddingRight=e.display.nativeBarWidth+"px";e.addKeyMap(this.keyMap=F(b,{moveFocus:function(k,u){d.changeActive(d.selectedHint+k,u)},setFocus:function(k){d.changeActive(k)},menuSize:function(){return d.screenAmount()},length:l.length,close:function(){b.close()},pick:function(){d.pick()},data:a}));if(b.options.closeOnUnfocus){var B;e.on("blur",this.onBlur=function(){B=setTimeout(function(){b.close()},100)});e.on("focus",this.onFocus=function(){clearTimeout(B)})}e.on("scroll",this.onScroll=
function(){var k=e.getScrollInfo(),u=e.getWrapperElement().getBoundingClientRect(),C=t+A.top-k.top,v=C-(window.pageYOffset||(document.documentElement||document.body).scrollTop);z||(v+=c.offsetHeight);if(v<=u.top||v>=u.bottom)return b.close();c.style.top=C+"px";c.style.left=p+A.left-k.left+"px"});h.on(c,"dblclick",function(k){(k=x(c,k.target||k.srcElement))&&null!=k.hintId&&(d.changeActive(k.hintId),d.pick())});h.on(c,"click",function(k){(k=x(c,k.target||k.srcElement))&&null!=k.hintId&&(d.changeActive(k.hintId),
b.options.completeOnSingleClick&&d.pick())});h.on(c,"mousedown",function(){setTimeout(function(){e.focus()},20)});h.signal(a,"select",l[this.selectedHint],c.childNodes[this.selectedHint]);return!0}function G(b,a){if(!b.somethingSelected())return a;b=[];for(var d=0;d<a.length;d++)a[d].supportsSelection&&b.push(a[d]);return b}function D(b,a,d,e){b.async?b(a,e,d):(b=b(a,d))&&b.then?b.then(e):e(b)}h.showHint=function(b,a,d){if(!a)return b.showHint(d);d&&d.async&&(a.async=!0);a={hint:a};if(d)for(var e in d)a[e]=
d[e];return b.showHint(a)};h.defineExtension("showHint",function(b){var a=this.getCursor("start"),d=this.options.hintOptions,e={},c;for(c in E)e[c]=E[c];if(d)for(c in d)void 0!==d[c]&&(e[c]=d[c]);if(b)for(c in b)void 0!==b[c]&&(e[c]=b[c]);e.hint.resolve&&(e.hint=e.hint.resolve(this,a));b=e;a=this.listSelections();if(!(1<a.length)){if(this.somethingSelected()){if(!b.hint.supportsSelection)return;for(c=0;c<a.length;c++)if(a[c].head.line!=a[c].anchor.line)return}this.state.completionActive&&this.state.completionActive.close();
a=this.state.completionActive=new w(this,b);a.options.hint&&(h.signal(this,"startCompletion",this),a.update(!0))}});var H=window.requestAnimationFrame||function(b){return setTimeout(b,1E3/60)},I=window.cancelAnimationFrame||clearTimeout;w.prototype={close:function(){this.active()&&(this.tick=this.cm.state.completionActive=null,this.cm.off("cursorActivity",this.activityFunc),this.widget&&this.data&&h.signal(this.data,"close"),this.widget&&this.widget.close(),h.signal(this.cm,"endCompletion",this.cm))},
active:function(){return this.cm.state.completionActive==this},pick:function(b,a){a=b.list[a];a.hint?a.hint(this.cm,b,a):this.cm.replaceRange("string"==typeof a?a:a.text,a.from||b.from,a.to||b.to,"complete");h.signal(b,"pick",a);this.close()},cursorActivity:function(){this.debounce&&(I(this.debounce),this.debounce=0);var b=this.cm.getCursor(),a=this.cm.getLine(b.line);if(b.line!=this.startPos.line||a.length-b.ch!=this.startLen-this.startPos.ch||b.ch<this.startPos.ch||this.cm.somethingSelected()||
b.ch&&this.options.closeCharacters.test(a.charAt(b.ch-1)))this.close();else{var d=this;this.debounce=H(function(){d.update()});this.widget&&this.widget.disable()}},update:function(b){if(null!=this.tick){var a=this,d=++this.tick;D(this.options.hint,this.cm,this.options,function(e){a.tick==d&&a.finishUpdate(e,b)})}},finishUpdate:function(b,a){this.data&&h.signal(this.data,"update");a=this.widget&&this.widget.picked||a&&this.options.completeSingle;this.widget&&this.widget.close();(this.data=b)&&b.list.length&&
(a&&1==b.list.length?this.pick(b,0):(this.widget=new y(this,b),h.signal(b,"shown")))}};y.prototype={close:function(){if(this.completion.widget==this){this.completion.widget=null;this.hints.parentNode.removeChild(this.hints);this.completion.cm.removeKeyMap(this.keyMap);var b=this.completion.cm;this.completion.options.closeOnUnfocus&&(b.off("blur",this.onBlur),b.off("focus",this.onFocus));b.off("scroll",this.onScroll)}},disable:function(){this.completion.cm.removeKeyMap(this.keyMap);var b=this;this.keyMap=
{Enter:function(){b.picked=!0}};this.completion.cm.addKeyMap(this.keyMap)},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(b,a){b>=this.data.list.length?b=a?this.data.list.length-1:0:0>b&&(b=a?0:this.data.list.length-1);this.selectedHint!=b&&(a=this.hints.childNodes[this.selectedHint],a.className=a.className.replace(" CodeMirror-hint-active",""),a=this.hints.childNodes[this.selectedHint=b],a.className+=" CodeMirror-hint-active",a.offsetTop<this.hints.scrollTop?
this.hints.scrollTop=a.offsetTop-3:a.offsetTop+a.offsetHeight>this.hints.scrollTop+this.hints.clientHeight&&(this.hints.scrollTop=a.offsetTop+a.offsetHeight-this.hints.clientHeight+3),h.signal(this.data,"select",this.data.list[this.selectedHint],a))},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}};h.registerHelper("hint","auto",{resolve:function(b,a){var d=b.getHelpers(a,"hint"),e;return d.length?(b=function(c,l,f){function m(n){if(n==g.length)return l(null);
D(g[n],c,f,function(p){p&&0<p.list.length?l(p):m(n+1)})}var g=G(c,d);m(0)},b.async=!0,b.supportsSelection=!0,b):(e=b.getHelper(b.getCursor(),"hintWords"))?function(c){return h.hint.fromList(c,{words:e})}:h.hint.anyword?function(c,l){return h.hint.anyword(c,l)}:function(){}}});h.registerHelper("hint","fromList",function(b,a){var d=b.getCursor(),e=b.getTokenAt(d);b=h.Pos(d.line,e.end);if(e.string&&/\w/.test(e.string[e.string.length-1])){var c=e.string;d=h.Pos(d.line,e.start)}else c="",d=b;e=[];for(var l=
0;l<a.words.length;l++){var f=a.words[l];f.slice(0,c.length)==c&&e.push(f)}if(e.length)return{list:e,from:d,to:b}});h.commands.autocomplete=h.showHint;var E={hint:h.hint.auto,completeSingle:!0,alignWithWord:!0,closeCharacters:/[\s()\[\]{};:>,]/,closeOnUnfocus:!0,completeOnSingleClick:!0,container:null,customKeys:null,extraKeys:null};h.defineOption("hintOptions",null)});
