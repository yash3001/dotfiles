'use strict';Registry.require("promise statistics helper xmlhttprequest uri convert tools".split(" "),()=>{const H=rea.FEATURES,y=Registry.get("promise");let R,S;const E=Registry.get("uri"),I=Registry.get("helper"),K=Registry.get("convert"),J=Registry.get("tools"),L=Registry.get("statistics");let T;const Z=J.createQueue(1),U=w=>{const l=y();K.blob2str(w,(d,m)=>{m?l.reject(m):l.resolve(d)});return l.promise()},D=(w,l)=>(w=(w?w.split("/"):[]).concat(l?[l]:[]).join("/"))?("/"==w.substr(0,1)?"":"/")+
w:"",aa=(w,l)=>{l=new l(w);Object.keys(w).forEach(d=>{const m=Object.getOwnPropertyDescriptor(w,d);if(m.get){const t={get:m.get,enumerable:!0};m.set&&(t.set=m.set);Object.defineProperty(l,d,t)}else l[d]=l[d]||w[d]});Object.keys(l).forEach(d=>{const m=Object.getOwnPropertyDescriptor(l,d);m.get||m.set||(w[d]=w[d]||l[d])});w.config=l.config=I.assign(w.config||{},l.config||{});return l},N=function(w){let l={type:w,extend:function(d){return l=aa(l,d)},request:function(d){const m=()=>{const t=y(),f=a=>
{console.log("rest service: request failed",a);t.reject(a)},q="xml"===d.responseType,e="headers"===d.responseType;(q||e)&&delete d.responseType;S(d,{onload:function(a){if([200,201,204,207].includes(a.status)){if(q)if(d.anonymous||d.fetch){const b=new window.DOMParser;a.result=b.parseFromString(a.responseText,"text/xml")}else a.result=a.responseXML;else a.result=e?R.parseHeaders(a.responseHeaders):a.response;t.resolve(a)}else f(a)},onerror:f,ontimeout:f,onprogress:t.notify},{internal:!0});return t.promise()};
return d.no_queue?m():Z.add(m)},error:function(d){let m=d.status;try{m=m+" | "+d.responseText}catch(t){}L.tC(w,"error","request: "+m)},wait:function(d){return function(){return d.apply(this,arguments).then(m=>m,m=>y.Breach(m?m.responseText||m.statusText:null))}}};return l},Q=function(w){const l=w.type;let d=[],m=null,t;const f={config:{auth_prefix:"Bearer"},changes:(()=>{let e;return{listen:function(){e||(e=y(),f.watch&&f.watch.start());return e.promise()},notify:function(a){e.notify(a)}}})(),request:function(e){e.no_auth||
(e.headers=e.headers||{},e.headers.Authorization=f.config.auth_prefix+" "+f.credentials.access_token);return w.request(e)},oauth:(()=>{let e;const a={run:function(){if(t)return t;let b=y();const h=t=b.promise();e="!!"+l+"-"+I.createUUID();let p=f.credentials?f.credentials.refresh_token:null;const g=(n,c)=>{f.credentials=c;b.resolve();b=null;n&&n.close()};(()=>{if(!f.config.refresh_supported||!p)return y.Pledge();const n=y(),c=()=>{p=null;delete f.credentials.refresh_token};S({url:a.getRefreshUrl(p),
fetch:!H.RUNTIME.SAFARI},{onload:function(v){if(v=a.onUrl(v.finalUrl))v.error||!v.access_token?(L.tC(l,"error","auth refresh token: "+(v.error||"!access_token")),c()):g(null,v)},onerror:c,ondone:n.resolve});return n.promise()})().then(()=>{if(b){if(!f.config.refresh_supported)return y.Pledge();var n=y(),c=T({url:a.getRefreshUrl()});c.promise.progress(v=>{let z;b&&(z=a.onUrl(v.url))&&(z.error||!z.access_token?(L.tC(l,"error","auth refresh: "+(z.error||"!access_token")),f.config.refresh_supported=!1):
g(c,z))}).always(n.resolve);return n.promise()}}).then(()=>{if(b){var n=y(),c=T({url:a.getAuthUrl()});c.promise.progress(v=>{let z;b&&(z=a.onUrl(v.url))&&(z.error||!z.access_token?L.tC(l,"error","auth: "+(z.error||"!access_token")):g(c,z))}).always(n.resolve);return n.promise()}}).done(()=>{t=null;b&&b.reject("auth_failed")});return h},getAuthUrl:function(){return f.config.request_uri+"?"+E.hash2params({response_type:f.config.response_type,client_id:f.config.client_id,redirect_uri:f.config.redirect_uri,
state:e,scope:f.config.scope})},getRefreshUrl:function(b){return f.config.redirect_uri+"?"+E.hash2params({client_id:f.config.client_id,redirect_uri:f.config.redirect_uri,state:e,scope:f.config.scope,refresh_token:b})},onUrl:function(b){let h,p;if(b&&0===b.indexOf(f.config.redirect_uri)&&(p=E.parse(b))&&(h=E.params2hash(p))&&(h.access_token||h.error)&&h.state===e)return{uid:h.uid,access_token:h.access_token,refresh_token:h.refresh_token,error:h.error}}};return a})(),wait:function(e){return w.wait(function(){if(f.credentials.access_token)return e.apply(this,
arguments);{const a=arguments,b=y();d.push(function(){b.consume(e.apply(this,a))});f.oauth.run().done(()=>{d.forEach(h=>{h()});d=[]}).fail(h=>{b.reject(h)});return b.promise()}})}},q=H.HTML5.LOCALSTORAGE;Object.defineProperty(f,"credentials",{get:function(){if(null===m){L.tC(l,"init");if(q)try{const e=JSON.parse(q.getItem(f.config.storage_key));m={uid:e.uid,access_token:e.access_token,refresh_token:e.refresh_token}}catch(e){}m=m||{}}return m},set:function(e){if(q)try{q.setItem(f.config.storage_key,
JSON.stringify({uid:e.uid,access_token:e.access_token,refresh_token:e.refresh_token}))}catch(a){}m=e},enumerable:!0});return f},ba=function(w){const l=w.type;let d=null;const m={config:{},changes:(()=>{let t;return{listen:function(){t||(t=y(),m.watch&&m.watch.start());return t.promise()},notify:function(f){t.notify(f)}}})(),request:function(t){if(!m.credentials.basic_auth)return y.Breach("Authentication failed");t.no_auth||(t.headers=t.headers||{},t.headers.Authorization="Basic "+m.credentials.basic_auth);
return w.request(t)},wait:function(t){return w.wait(function(){return t.apply(this,arguments)})}};Object.defineProperty(m,"credentials",{get:function(){null===d&&(L.tC(l,"init"),d={basic_auth:m.config.basic_auth});return d},set:function(t){d=t},enumerable:!0});return m},Y=function(w){let l,d,m,t,f=null,q=null,e,a,b,h,p;const g=u=>{let x;u&&(x=u.firstChild.nextSibling?u.firstChild.nextSibling:u.firstChild);return x},n=u=>w.wait(function(){const x=arguments;return B.init().then(function(){return u.apply(this,
x)})}),c=(u,x)=>{let r,k;if((r=u.getElementsByTagNameNS("*",x)[0])&&(k=r.firstChild))return k.nodeValue},v=u=>{const x=[];u=u.getElementsByTagNameNS("*","response");for(let F=0;F<u.length;F++){var r=u[F],k=c(r,"href");k=k.replace(/\/$/,"");var A=r.getElementsByTagNameNS("*","propstat")[0].getElementsByTagNameNS("*","prop")[0];r=c(A,"getlastmodified");const O=c(A,"getetag"),M=c(A,"getcontentlength");A=A.getElementsByTagNameNS("*","resourcetype")[0].getElementsByTagNameNS("*","collection")[0];k=k.replace(new RegExp("^("+
[I.escapeForRegExpURL(d+l)+"/?",I.escapeForRegExpURL(m+l)+"/?"].join("|")+")"),"");A||(k={etag:O,name:k,modifiedTime:r?(new Date(r)).getTime():void 0,size:0<=M?M:void 0,removed:-1==M},x.push(k))}return x},z=(u,x)=>{x=x||{};x.set_current_list&&(e={});return B.request({method:"PROPFIND",url:u,headers:{"Content-Type":"text/xml; charset=UTF-8",Depth:void 0!==x.depth?x.depth:1},responseType:"xml"}).then(r=>{r=r.result;var k;if(null===r||!(k=g(r))||!k.childNodes)return y.Breach();r=v(k);x.set_current_list&&
((k=c(k,"td:cursor"))&&(a=k),r.forEach(A=>{e[A.name]=A}));return r})},C=(u,x)=>{const r={"Content-Type":"text/xml; charset=UTF-8",Depth:1,Timeout:90};x&&(r.Cursor=x);return B.request({method:"SUBSCRIBE",url:u,headers:r,responseType:"xml",no_queue:!0}).then(k=>{k=k.result;var A;if(null===k)return y.Pledge({changes:[],cursor:a});if(!(A=g(k))||!A.childNodes)return y.Breach();k=v(A);A=c(A,"td:cursor");return{changes:k,cursor:A}})};var B={config:{watch_interval:36E5},request:function(u){u.headers=u.headers||
{};u.headers["User-Agent"]="Tampermonkey";u.headers.Cookie="";return w.request.apply(this,arguments).then(x=>x,x=>{if(!x||[403,500].includes(x.status))return u.backoff=2*(u.backoff||1E3),J.sleep(u.backoff).then(()=>B.request(u));if(404==x.status)return y.Pledge(x);B.error(x);return y.Breach(x)})},init:function(){if(t)return t;l=D(B.config.root,B.config.path);d=B.config.url||"";"/"==d.slice(-1)&&(d=d.slice(0,-1));m=E.parse(d).pathname;"/"==m.slice(-1)&&(m=m.slice(0,-1));const u=y();t=u.promise();const x=
d+l;B.request({method:"OPTIONS",url:d,responseType:"headers"}).done(r=>{r=r.result;let k;r&&(k=r["access-control-allow-methods"])&&k.includes("EDITOR")&&(p=!0)}).always(()=>{z(x,{depth:0}).done(u.resolve).fail(()=>{const r=[];y.onebyone(l.split("/").filter(k=>k).map(k=>{r.push(k);const A=r.join("/");return()=>B.request({method:"MKCOL",url:d+"/"+A,headers:{"Content-Type":"text/xml; charset=UTF-8"},responseType:"xml"})})).done(u.resolve).fail(u.reject)})});return t},list:n(u=>z(d+l,{set_current_list:!0}).then(x=>
{const r={};return x.map(k=>{if(!u){if(r[k.name])return;r[k.name]=!0}return{name:k.name,size:k.size||0,id:k.id,etag:k.etag,md5:k.md5Checksum,modified:k.modifiedTime,precision:1E3,removed:k.removed}}).filter(k=>k)})),get:n(u=>B.request({method:"GET",url:d+D(l,u.name||u),headers:{"Content-Type":"text/xml; charset=UTF-8"},responseType:"arraybuffer"}).then(x=>new Blob([x.result]))),put:n((u,x,r)=>{const k=u.name||u;let A,F,O;u={"Content-Type":"application/octet-stream"};const M=null===q;r&&r.lastModified&&
(A=r.lastModified,O=(new Date(r.lastModified)).toISOString(),F=r.lastModified/1E3,q||M)&&(u["X-OC-Mtime"]=F);return B.request({method:"PUT",url:d+D(l,k),headers:u,data_type:"typified",data:{type:"raw",value:x},responseType:"headers"}).then(P=>{if((P=P.result)&&M){let G;q="accepted"==P["x-oc-mtime"]||P.date&&(G=(new Date(P.date)).getTime())&&(G==A||G==Math.floor(F))?!0:!1}if(!q&&!f&&O)return B.request({method:"PROPPATCH",url:d+D(l,k),headers:{"Content-Type":"text/xml; charset=UTF-8"},responseType:"xml",
data:['<?xml version="1.0"?><d:propertyupdate xmlns:d="DAV:"><d:set><d:prop>',"<d:getlastmodified>"+O+"</d:getlastmodified>","</d:prop></d:set></d:propertyupdate>"].join("")}).then(G=>{G=G.result;let V,W,X;G&&(V=G.childNodes[0])&&(W=V.getElementsByTagNameNS("*","status")[0])&&(X=W.firstChild.nodeValue)&&-1!=X.search(/HTTP\/[0-9\.]+ 403/)&&(console.warn("WebDAV: no way to set file modification date! This might cause redundant up and downloads."),f=!0)},()=>{console.warn("WebDAV: no way to set file modification date! This might cause redundant up and downloads.");
f=!0})})}),delete:n(u=>B.request({method:"DELETE",url:d+D(l,u.name||u),headers:{"Content-Type":"text/xml; charset=UTF-8"}})),watch:{start:function(){if(!b){b=!0;var u=null,x=()=>{h=null;if(b)if(!1===u){const r=e;z(d+l,{set_current_list:!0}).then(()=>{r&&(Object.keys(r).forEach(k=>{const A=e[k];k=r[k];A?k.modifiedTime!=A.modifiedTime&&w.changes.notify({time:A.modifiedTime,name:A.name}):w.changes.notify({time:Date.now(),name:k.name,removed:!0})}),Object.keys(e).forEach(k=>{r[k]||(k=e[k],w.changes.notify({time:k.modifiedTime,
name:k.name}))}))}).fail(k=>{console.warn("WebDAV: file changes check failed",k)}).always(()=>{h=window.setTimeout(x,B.config.watch_interval)})}else{let r=100;C(d+l,a).then(k=>{const A=k.changes;a=k.cursor;r=1;A.forEach(F=>{w.changes.notify({time:F.modifiedTime,name:F.name,removed:F.removed})})},()=>{if(null===u)u=!1;else return r*=2,J.sleep(r)}).always(x)}};n(()=>{if(!b)return y.Breach();x();return y.Pledge()})()}},stop:function(){b=!1;h&&(window.clearTimeout(h),h=null)}},getRemoteUrl:function(u){if(p)return d+
D(l,u)+"?method=editor#bypass=true"},getRemoteDomains:function(){return[E.parse(d).origin.replace(/^.*:\/\//,"")]}};return B};Registry.register("cloud","e1582c36",{init:function(w,l,d){T=w;R=Registry.get("xmlhttprequest",l,d);S=R.run},drive:function(){let w,l;(w=H.HTML5.LOCALSTORAGE)&&(l=w.getItem("dropbox_poll_interval"))||(l=18E5);return(new N("drive")).extend(Q).extend(function(d){let m,t;const f={config:{redirect_uri:"https://auth.tampermonkey.net/oauth.php",refresh_supported:!0,request_uri:"https://accounts.google.com/o/oauth2/v2/auth",
client_id:"408438522028-3cgn3t3jas3fak7isbnfod1q4h15g2fv.apps.googleusercontent.com",storage_key:"gd_config",scope:"https://www.googleapis.com/auth/drive.appdata",response_type:"token",watch_interval:l},request:function(q){return d.request.apply(this,arguments).then(e=>e,e=>{if(!e||[403,500].includes(e.status))return q.backoff=2*(q.backoff||1E3),J.sleep(q.backoff).then(()=>f.request(q));if([400,401].includes(e.status)){if(console.warn("Google Drive: authentication error",e),delete f.credentials.access_token,
!q.retry_auth)return q.retry_auth=!0,f.oauth.run().then(()=>f.request(q))}else if(404==e.status)return y.Pledge(e);f.error(e);return y.Breach(e)})},list:d.wait(q=>{let e=[];const a=y(),b=p=>"https://www.googleapis.com/drive/v3/files?"+E.hash2params({spaces:"appDataFolder",pageToken:p,orderBy:"modifiedTime desc",fields:"nextPageToken, files(id, size, name, modifiedTime, md5Checksum)",pageSize:500}),h=p=>f.request({method:"GET",url:p,headers:{"Content-Type":"application/json"}}).then(g=>{g=(g=g.result)?
JSON.parse(g):{files:[]};e=e.concat(g.files);if(g.nextPageToken)return h(b(g.nextPageToken));a.resolve(e)});h(b());return a.promise().then(p=>{const g={};return p.map(n=>{if(!q){if(g[n.name])return;g[n.name]=!0}return{name:n.name,size:n.size||0,id:n.id,md5:n.md5Checksum,modified:(new Date(n.modifiedTime)).getTime()}}).filter(n=>n)})}),get:d.wait(q=>f.request({method:"GET",url:"https://www.googleapis.com/drive/v3/files/"+(q.id||q)+"?"+E.hash2params({spaces:"appDataFolder",alt:"media"}),responseType:"arraybuffer"}).then(e=>
new Blob([e.result]))),put:d.wait((q,e,a)=>{const b=q.name||q,h=q.id,p=I.createUUID();return y.Pledge().then(()=>{if(e)return U(e)}).then(g=>{const n=a&&a.lastModified?(new Date(a.lastModified)).toISOString():void 0,c=[];c.push("--"+p);c.push("Content-Type: application/json");c.push("");c.push(JSON.stringify({name:b,parents:h?void 0:["appDataFolder"],modifiedTime:n}));c.push("--"+p);g&&(c.push("Content-Type: application/octet-stream"),c.push("Content-Transfer-Encoding: base64"),c.push(""),c.push(K.Base64.encode(g)),
c.push("--"+p+"--"));c.push("");return f.request({method:h||!g?"PATCH":"POST",url:"https://www.googleapis.com/"+(g?"upload/":"")+"drive/v3/files"+(h?"/"+h:"")+"?"+E.hash2params({uploadType:"multipart"}),headers:{"Content-Type":"multipart/related; boundary="+p},data:c.join("\r\n")})})}),delete:d.wait(q=>f.request({method:"DELETE",url:"https://www.googleapis.com/drive/v3/files/"+(q.id||q)+"?"+E.hash2params({spaces:"appDataFolder"}),headers:{"Content-Type":" application/json"}})),revoke:d.wait(()=>{const q=
f.credentials.access_token;return q?d.request({method:"GET",url:"https://accounts.google.com/o/oauth2/revoke?"+E.hash2params({token:q})}):y.Breach()}),compare:function(q,e){const a=y();let b;(b=q.md5)&&b==K.MD5(e,"utf-8")?a.resolve(!0):a.resolve(!1);return a.promise()},watch:{start:function(){if(!m){m=!0;var q,e=()=>{t=null;m&&f.request({method:"GET",url:"https://www.googleapis.com/drive/v3/changes/?"+E.hash2params({pageToken:q,spaces:"appDataFolder",pageSize:1E3,includeRemoved:!0}),headers:{"Content-Type":" application/json"}}).then(a=>
{a=a.result;if(!m)return y.Breach();const b=a?JSON.parse(a):{};if(!(q=b.newStartPageToken))return console.warn("Google Drive: watch token error",a),f.watch.stop();b.nextPageToken&&console.warn("Google Drive: too much changes",a);(b.changes||[]).forEach(h=>{let p,g;"file"===h.type&&(g=h.file)&&(p=Date.parse(h.time),isNaN(p)&&(p=Date.now()),d.changes.notify({id:g.id,time:p,name:g.name,removed:h.removed}))})}).fail(a=>{console.warn("Google Drive: file changes check failed",a)}).always(()=>{t=window.setTimeout(e,
f.config.watch_interval)})};d.wait(()=>m?f.request({method:"GET",url:"https://www.googleapis.com/drive/v3/changes/startPageToken",headers:{"Content-Type":" application/json"}}).then(a=>{a=a.result;if(!(q=(a?JSON.parse(a):{}).startPageToken))return console.warn("Google Drive: watch token error",a),f.watch.stop();e()}):y.Breach())()}},stop:function(){m=!1;t&&(window.clearTimeout(t),t=null)}}};return f})},dropbox:function(w){const l=w.path||"";let d,m;(d=H.HTML5.LOCALSTORAGE)&&(m=d.getItem("dropbox_poll_interval"))||
(m=18E5);return(new N("dropbox")).extend(Q).extend(function(t){let f,q,e,a,b=!0;const h=g=>{let n=[];const c=y(),v=z=>p.request({method:"POST",url:"https://api.dropboxapi.com/2/files/list_folder"+(z?"/continue":""),headers:{"Content-Type":" application/json"},data:{path:z?void 0:D(l),cursor:z}}).then(C=>{C=(C=C.result)?JSON.parse(C):{entries:[]};n=n.concat(C.entries);if(C.has_more&&C.cursor)return v(C.cursor);c.resolve({list:n,cursor:C.cursor})}).fail(c.reject);b?(b=!1,p.put(".version",new Blob([rea.extension.manifest.version])).then(()=>
{v(g)}).fail(c.reject)):v(g);return c.promise()};var p={config:{redirect_uri:"https://auth.tampermonkey.net/oauth.php",request_uri:"https://www.dropbox.com/oauth2/authorize",client_id:"gq3auc9yym0e21y",storage_key:"db_config",response_type:"token",watch_interval:m},request:function(g){return t.request.apply(this,arguments).then(n=>n,n=>{if(!n||[500,429].includes(n.status))return g.backoff=2*(g.backoff||1E3),J.sleep(g.backoff).then(()=>p.request(g));if([401].includes(n.status)&&(console.warn("Dropbox: authentication error",
n),delete p.credentials.access_token,!g.retry_auth))return g.retry_auth=!0,p.oauth.run().then(()=>p.request(g));p.error(n);return y.Breach(n)})},list:t.wait(g=>h().then(n=>{const c={};a=n.cursor;return n.list.map(v=>{if(!g){if(c[v.name])return;c[v.name]=!0}return{name:v.name,size:v.size,dropbox_hash:v.content_hash,modified:(new Date(v.client_modified)).getTime(),precision:1E3}}).filter(v=>v)}).always(()=>{e&&a&&(e(),e=null)})),get:t.wait(g=>p.request({method:"POST",url:"https://content.dropboxapi.com/2/files/download",
headers:{"Dropbox-API-Arg":JSON.stringify({path:D(l,g.name||g)})},responseType:"arraybuffer"}).then(n=>new Blob([n.result]))),put:t.wait((g,n,c)=>{g=g.name||g;c=c&&c.lastModified?(new Date(c.lastModified)).toISOString().match(/[^:]*:[^:]*:[^:.a-zA_Z]*/)[0]+"Z":void 0;return p.request({method:"POST",url:"https://content.dropboxapi.com/2/files/upload",headers:{"Dropbox-API-Arg":JSON.stringify({path:D(l,g),client_modified:c,mode:"overwrite"}),"Content-Type":"application/octet-stream"},data_type:"typified",
data:{type:"raw",value:n}})}),delete:t.wait(g=>p.request({method:"POST",url:"https://api.dropboxapi.com/2/files/delete",headers:{"Content-Type":" application/json"},data:{path:D(l,g.name||g)}})),compare:function(g,n){const c=y();if(window.crypto&&window.ArrayBuffer){const v=K.str2arrbuf(n,"utf-8"),z=[],C=v.byteLength;let B=1;const u=()=>{if(0===--B){let x=new window.ArrayBuffer;z.forEach(r=>{{var k=x;const A=new Uint8Array(k.byteLength+r.byteLength);A.set(new Uint8Array(k),0);A.set(new Uint8Array(r),
k.byteLength);x=A.buffer}});window.crypto.subtle.digest("SHA-256",x).then(r=>{r=Array.from(new Uint8Array(r)).map(k=>("00"+k.toString(16)).slice(-2)).join("");c.resolve(r==g.dropbox_hash)})}};for(let x=0,r=0;r<C;r+=4194304,x++)(k=>{z.push(null);B++;window.crypto.subtle.digest("SHA-256",v.slice(r,r+Math.min(4194304,C-r))).then(A=>{z[k]=A;u()},()=>{console.warn("Dropbox: unable to calculate SHA-256 hashes");c.reject()})})(x);u()}else console.warn("Dropbox: unable to calculate SHA-256 hashes"),c.reject();
return c.promise()},watch:{start:function(){if(!f){f=!0;var g=0,n=()=>{q=null;g=0;if(f){if(!a)return console.warn("Dropbox: watch token error",a),p.watch.stop();p.request({method:"POST",url:"https://notify.dropboxapi.com/2/files/list_folder/longpoll",headers:{"Content-Type":" application/json"},no_auth:!0,no_queue:!0,data:{cursor:a,timeout:180}}).then(c=>{const v=c.result;if(!f)return y.Breach();c=v?JSON.parse(v):{};c.backoff&&(g=1E3*c.backoff);return c.changes?J.sleep(6E4).then(()=>h(a)).then(z=>
(a=z.cursor)?z.list:(console.warn("Dropbox: watch token error",v),p.watch.stop())):null}).then(c=>{c&&c.forEach(v=>{let z;const C=v[".tag"];["file","deleted"].includes(C)&&(z=Date.parse(v.server_modified),t.changes.notify({id:v.id,time:z,name:v.name,removed:"deleted"==C}))})}).fail(c=>{console.warn("Dropbox: file changes check failed",c)}).always(()=>{q=window.setTimeout(n,g+p.config.watch_interval)})}};t.wait(()=>{if(!f)return y.Breach();a?n():e=n;return y.Pledge()})()}},stop:function(){f=!1;q&&
(window.clearTimeout(q),q=null)}},getRemoteDomains:function(){return["dropbox.com","dropboxapi.com"]}};return p})},onedrive:function(w){const l=w.path||"";let d,m,t;(d=H.HTML5.LOCALSTORAGE)&&(m=d.getItem("onedrive_poll_interval"))||(m=18E5);return(new N("onedrive")).extend(Q).extend(function(f){let q,e;const a=h=>{const p=y();let g=[];const n=c=>b.request({method:"GET",url:c||"https://api.onedrive.com/v1.0/drive/special/approot:"+D(l)+":/children",headers:{"Content-Type":" application/json"}}).then(v=>
{v=(v=v.result)?JSON.parse(v):{value:[]};g=g.concat(v.value.map(z=>({id:z.id,name:z.name,size:z.size,sha1:z.file&&z.file.hashes?z.file.hashes.sha1Hash:void 0,modified:(new Date((z.fileSystemInfo?z.fileSystemInfo.lastModifiedDateTime:null)||z.lastModifiedDateTime)).getTime()})));if(v["@odata.nextLink"])return n(v["@odata.nextLink"]);h.set_current_list&&(t=g);p.resolve(g)});n();return p.promise()};var b={config:{redirect_uri:"https://auth.tampermonkey.net/oauth.php",request_uri:"https://login.live.com/oauth20_authorize.srf",
client_id:"000000004C1A3122",storage_key:"od_config",response_type:"token",scope:"onedrive.appfolder",watch_interval:m},getRemoteDomains:function(){return["onedrive.live.com"]},request:function(h){return f.request.apply(this,arguments).then(p=>p,p=>{if(!p||[403,500].includes(p.status))return h.backoff=2*(h.backoff||1E3),J.sleep(h.backoff).then(()=>b.request(h));if([401].includes(p.status)){if(console.warn("OneDrive: authentication error",p),delete b.credentials.access_token,!h.retry_auth)return h.retry_auth=
!0,b.oauth.run().then(()=>b.request(h))}else if(404==p.status)return y.Pledge(p);b.error(p);return y.Breach(p)})},list:f.wait(()=>a({set_current_list:!0})),get:f.wait(h=>b.request({method:"GET",url:"https://api.onedrive.com/v1.0/drive/special/approot:"+D(l,encodeURIComponent(h.name||h))+":/content",responseType:"arraybuffer"}).then(p=>new Blob([p.result]))),put:f.wait((h,p,g)=>{h=encodeURIComponent((h.name||h).replace(/[#%<>:"|\?\*\/\\]/g,"-"));return b.request({method:"PUT",url:"https://api.onedrive.com/v1.0/drive/special/approot:"+
D(l,h)+":/content",headers:{"Content-Type":"application/octet-stream"},data_type:"typified",data:{type:"raw",value:p}}).then(n=>{const c=g&&g.lastModified?(new Date(g.lastModified)).toISOString():void 0;if(!c)return n;n=JSON.parse(n.result);return b.request({method:"PATCH",url:"https://api.onedrive.com/v1.0/drive/items/"+n.id,headers:{"Content-Type":"application/json"},data:JSON.stringify({fileSystemInfo:{lastModifiedDateTime:c}})})})}),delete:f.wait(h=>b.request({method:"DELETE",url:"https://api.onedrive.com/v1.0/drive/special/approot:"+
D(l,encodeURIComponent(h.name||h))})),watch:{start:function(){if(!q){q=!0;var h=()=>{e=null;if(q){var p=t;a({set_current_list:!0}).then(()=>{if(p){var g={},n={};t.forEach(c=>{g[c.id]=c});p.forEach(c=>{n[c.id]=c});Object.keys(n).forEach(c=>{const v=g[c];c=n[c];v?c.modified!=v.modified&&f.changes.notify({time:v.modified,name:v.name}):f.changes.notify({time:Date.now(),name:c.name,removed:!0})});Object.keys(g).forEach(c=>{n[c]||(c=g[c],f.changes.notify({time:c.modified,name:c.name}))})}}).fail(g=>{console.warn("OneDrive: file changes check failed",
g)}).always(()=>{e=window.setTimeout(h,b.config.watch_interval)})}};b.wait(()=>{if(!q)return y.Breach();h();return y.Pledge()})()}},stop:function(){q=!1;e&&(window.clearTimeout(e),e=null)}}};return b})},yandex:function(w){let l,d;(l=H.HTML5.LOCALSTORAGE)&&(d=l.getItem("yandex_poll_interval"))||(d=18E5);return(new N("yandex")).extend(Q).extend(Y).extend(function(m){const t=m.request;m.request=a=>(()=>{a.headers=a.headers||{};a.headers["X-Requested-With"]="XMLHttpRequest";if(window.forge_sha256&&"PUT"==
a.method&&a.data&&"raw"==a.data.type&&a.data.value){const b=y();U(a.data.value).then(h=>{a.headers.Etag=K.MD5(h);a.headers.Sha256=window.forge_sha256(h)}).always(b.resolve);return b.promise()}return y.Pledge()})().then(()=>t(a).then(b=>b,b=>b&&[401].includes(b.status)&&(console.warn("Yandex: authentication error",b),delete e.credentials.access_token,!a.retry_auth)?(a.retry_auth=!0,e.oauth.run().then(()=>t(a))):b));const f=m.init;let q;m.init=()=>{if(q)return q;const a=y();q=a.promise();e.request({method:"GET",
url:"https://cloud-api.yandex.net/v1/disk/"}).done(b=>{b=(b=b.result)?JSON.parse(b):{};b.total_space&&b.used_space&&(b.used_space+5E7>b.total_space?console.warn("Yandex: low disk space warning, only "+(b.total_space-b.used_space)+" bytes available"):console.log("Yandex: "+(b.total_space-b.used_space)+" bytes on disk available!"))}).always(()=>{a.consume(f())});return q};var e={config:I.assign({root:"/Programs/Tampermonkey",url:"https://webdav.yandex.ru",redirect_uri:"https://auth.tampermonkey.net/oauth.php",
refresh_supported:!0,request_uri:"https://oauth.yandex.com/authorize",client_id:"a591fcd2ccd248f0baa84222898065f4",storage_key:"ya_config",response_type:"token",auth_prefix:"OAuth",watch_interval:d},w),getRemoteDomains:function(){return["disk.yandex.com"]},list:function(a){return m.list(a).then(b=>b.map(h=>{h.md5=h.etag;return h}))},compare:function(a,b){const h=y();let p;(p=a.md5)&&p==K.MD5(b,"utf-8")?h.resolve(!0):h.resolve(!1);return h.promise()}};return e})},webdav:function(w){var l;let d;(l=
H.HTML5.LOCALSTORAGE)&&(d=l.getItem("webdav_poll_interval"))||(d=18E5);if(l=w.url){var m=l.toLowerCase();m.startsWith("webdav")?w.url=l.replace(/^webdav/i,"http"):m.startsWith("http")||(w.url=`http://${l}`)}return(new N("webdav")).extend(ba).extend(Y).extend(function(){return{config:I.assign({root:"Tampermonkey",watch_interval:d},w)}})}})});
