'use strict';Registry.require(["promise","helper"],()=>{const n=Registry.get("helper"),k=Registry.get("promise");let f={};const p=a=>{const b=n.createUUID();f[b]=a;return b},q=(a,b)=>{const d=k();void 0===b&&(b=!0);rea.tabs.getSelected(null,c=>{c=c?c.index:void 0;rea.tabs.create({url:rea.extension.getURL("ask.html")+"?aid="+a,active:b,index:c},e=>{e||(console.error("rea.tabs.create failed -> giving up now!"),d.reject({error:"rea.tabs.create failed -> giving up now!"}));d.resolve({id:e.id,close:function(){rea.tabs.remove(e.id)}})})});
return d.promise()};let g=null;const r=()=>{const a=Date.now(),b=f;f={};const d=Object.keys(b);d.forEach(c=>{const e=b[c];e&&15E3>a-e.ts?f[c]=e:e.com.reject()});g&&0===d.length&&(window.clearInterval(g),g=null)};let l=!1;const h=(a,b)=>{l||m.init();null===g&&(g=window.setInterval(r,5E3));const d=k();a={ts:Date.now(),com:d,preparat:b,type:a};a=p(a);return q(a,b.active).then(c=>d.promise().done(e=>{(e.ok||e.aborted)&&c.close()}))},m={init:function(){l||(l=!0)},onMessage:function(a){const b=k(),d=a.aid,
c=f[d];if(c)if(c.aborter&&(window.clearTimeout(c.aborter),delete c.aborter),"ping"==a.method)f[d].ts=Date.now(),b.resolve({pong:!0});else if("preparat"==a.method)b.resolve({preparat:c.preparat,type:c.type});else if("install"==a.method)c.com.resolve({ok:!0}),b.resolve({}),delete f[d];else if("import"==a.method)c.com.resolve({ok:!0,import_ids:a.import_ids,global_settings:a.global_settings}),b.resolve({}),delete f[d];else if("permission"==a.method)c.com.resolve({ok:!0,granted:a.granted,permissions:a.permissions,
origins:a.origins}),b.resolve({}),delete f[d];else if("unload"==a.method||"abort"==a.method){b.resolve({});const e=()=>{c.com.resolve({ok:!1,aborted:!0});delete f[d]};"abort"==a.method?e():c.aborter=window.setTimeout(e,3E3)}else"connect"==a.method&&(c.com.resolve(a),b.resolve({}),delete f[d]);else b.reject({error:"unknown_id",please_close:!0});return b.promise()},install:function(a){return h("install",a)},import:function(a){return h("import",a)},askForPermission:function(a,b,d){return h("permission",
{permissions:a.permissions,origins:a.origins,title:b,message:d})},installError:function(a){return h("install_error",a)},askForConnect:function(a){return h("connect",a)}};Registry.register("asker","e1582c36",m)});
